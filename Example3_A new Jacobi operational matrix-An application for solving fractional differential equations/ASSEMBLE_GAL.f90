	MODULE ASSEMBLE_GAL

	USE GSQUAD
	USE LUDECOMPOSITION
	USE BASIS
	USE LOADFUNCTION
	
	IMPLICIT NONE

CONTAINS



!------------------INTEGRAL CODE FOR THE STIFFNESS MATRIX ELEMENT--------------
SUBROUTINE GEN_KF(SOL)

	REAL*8, INTENT(OUT) :: SOL(DOF)
	
	REAL*8 :: LC_M(LC_NUMBS(1), LC_NUMBS(1)), DMY_M(LC_NUMBS(1), LC_NUMBS(1)), LC_F(LC_NUMBS(1))
	
	TYPE(FUNCTION_1D) :: LOCBS(2), LC_UH(NUMIC, LC_NUMBS(1)), EX_SOL
! 	TYPE(FUNCTION_1D) :: PU(2)

	REAL*8 :: FDBS, D
	INTEGER :: I, J, II, JJ, K, KK, G, PATCHROW, PATCHCOLUMN, ROW, COLUMN
	INTEGER :: LC_INDX(LC_NUMBS(1))
	
	LC_M(:,:) = 0.D0; LC_F(:) = 0.D0; SOL(:) = 0.0D0
	DMY_M(:,:) = 0.0D0
	
	!! Construct the stiffness matrix M_0 and load vector F_0 corresponding to the first patch Omega_0
	!-------------------------------------------------------------------------------------------------!
	ROW = 0
	DO I = 0, JORDER
		ROW = ROW + 1
		COLUMN = 0
		DO J = 0, JORDER
			COLUMN = COLUMN + 1
			IF (ROW<=(LC_NUMBS(1) - NUMIC)) THEN 
				DO K = 1, NUMGSPT
					LOCBS(1) = JACOBI_POLY(GSPT(1,K), I)	! Row
					LOCBS(2) = JACOBI_POLY(GSPT(1,K), J)	! Column
					FDBS = GET_FD_JACOBI_POLY(GSPT(1,K), J)	!Column
! 									PU(1) = PHYPU1D(GSPT(SUBIRNDX(PATCHROW,PATCHCOLUMN,II),K), PATCHROW)
! 									PU(2) = PHYPU1D(GSPT(SUBIRNDX(PATCHROW,PATCHCOLUMN,II),K), PATCHCOLUMN)
					!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
					!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
					
					!! Poisson eqn
					!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!
! 									LC_M(ROW, COLUMN) = LC_M(ROW, COLUMN) + ((LOCBS(1)%VAL(1)*PU(1)%VAL(0) + LOCBS(1)%VAL(0)*PU(1)%VAL(1))* (LOCBS(2)%VAL(1)*PU(2)%VAL(0) + LOCBS(2)%VAL(0)*PU(2)%VAL(1)))*GSW(SUBIRNDX(PATCHROW,PATCHCOLUMN,II),K)
					!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!
					
					!! 2nd order ODE (D^2u + u = g(x))
					!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!
! 									LC_M(ROW, COLUMN) = LC_M(ROW, COLUMN)  + (LOCBS(2)%VAL(2) + LOCBS(2)%VAL(0))*LOCBS(1)%VAL(0)*GSW(SUBIRNDX(PATCHROW,PATCHCOLUMN,II),K)
					!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!
					
					!! Example 2 in "On shifted Jacobi spectral approximation for solving fractional DE" (D^2u + sin(x)D^(1/2)u + xu = f(x))
					!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!
! 					LC_M(ROW, COLUMN) = LC_M(ROW, COLUMN) + (LOCBS(2)%VAL(2) + DSIN(GSPT(1,K))*FDBS + GSPT(1,K)*LOCBS(2)%VAL(0))*LOCBS(1)%VAL(0)*GSW(1,K)
					!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!
					
					!! Example 1 in Master Thesis "Multistage Shifted Jacobi Spectral Method for solving linear & nonlinear Fractional Differential Equations"
					!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!
! 					LC_M(ROW, COLUMN) = LC_M(ROW, COLUMN) + FDBS*LOCBS(1)%VAL(0)*GSW(1,K)
					!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!
					
					!! Example 3. in "A high order schema for the numerical solution of the fractional ordinary differential equations"
					!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!
! 					LC_M(ROW, COLUMN) = LC_M(ROW, COLUMN) + (FDBS + LOCBS(2)%VAL(0))*LOCBS(1)%VAL(0)*GSW(1,K)
					!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!
					
					!! Example of highly oscillating function
					!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!
! 					LC_M(ROW, COLUMN) = LC_M(ROW, COLUMN) + (FDBS)*LOCBS(1)%VAL(0)*GSW(1,K)
					!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!
					
					!! Example 3. in "A new Jacobi operational matrix-An application for solving fractional differential equations"
					!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!
					LC_M(ROW, COLUMN) = LC_M(ROW, COLUMN) + (FDBS + LOCBS(2)%VAL(0))*LOCBS(1)%VAL(0)*GSW(1,K)
					!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!
					
					!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
					!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
				ENDDO
			ENDIF
		ENDDO
		
		IF (ROW<=(LC_NUMBS(1) - NUMIC)) THEN 
			DO K = 1, NUMGSPT
				LOCBS(1) = JACOBI_POLY(GSPT(1,K), I)	! Row
				LC_F(ROW) = LC_F(ROW) + LDF1D(GSPT(1,K))*LOCBS(1)%VAL(0)*GSW(1,K)
			ENDDO
		ENDIF
	ENDDO
	
	! Impose the initial conditions -----> u^h(0) = I.C., D[u^h(0)] = I.C., ...
	EX_SOL = EXSOL(DOMAIN(1))
	DO II = 1, NUMIC
		! On matrix
		DO JJ = 0, JORDER
			LOCBS(2) = JACOBI_POLY(0.0D0, JJ)
			LC_M(LC_NUMBS(1) - NUMIC + II, JJ+1) = LOCBS(2)%VAL(II-1)
		ENDDO
		! On load vector
		IC(II) = EX_SOL%VAL(II-1)
		LC_F(LC_NUMBS(1) - NUMIC + II) = IC(II)
	ENDDO
		
	!-------------------------------------------------------------------------------------------------!
	
! 	OPEN(1, FILE = './data/f1')
! 	DO II=1, LC_NUMBS(1)
! 		WRITE(1,*) LC_F(II)
! 	ENDDO
! 	CLOSE(1)
! ! 
! 	OPEN(1, FILE = './data/k1')
! 	DO II=1, LC_NUMBS(1)
! 		WRITE(1,*) (LC_M(II,JJ), JJ=1,LC_NUMBS(1))
! 	ENDDO
! 	CLOSE(1)
	
	!! Copy M_0 & F_0 and then solve the linear system M_0[sol]=F_0
	!---------------------------------------------------------!
	DMY_M = LC_M
! 	INIT_F = LC_F
	
	CALL LUDCMP(LC_M, LC_NUMBS(1), LC_NUMBS(1), LC_INDX, D)
	CALL LUBKSB(LC_M, LC_NUMBS(1), LC_NUMBS(1), LC_INDX, LC_F)
	
	SOL(1:LC_NUMBS(1)) = LC_F(:)
	LC_M = DMY_M
! 	LC_F = INIT_F
	!---------------------------------------------------------!
	
! 	OPEN(1, FILE = './data/sol1')
! 	DO II = 1, LC_NUMBS(1)
! 		WRITE(1,*) SOL(II)
! 	ENDDO
! 	CLOSE(1)
	
	IF (NUMPATCH==1) THEN 
		GOTO 17
	ENDIF
	
	!! Construct linear system [M_k][sol]=[F_k] and solve it for each patches Omega_k
	!---------------------------------------------------------------------------------------------------------!
	DO K = 2, NUMPATCH
		!! Update the stiffness matrix M_k
		!---------------------------------------------------------------------------------------------------------!
		LC_M(1:LC_NUMBS(1)-NUMIC,:) = 0.0D0
		ROW = 0
		DO I = 0, JORDER
			ROW = ROW + 1
			COLUMN = 0
			DO J = 0, JORDER
				COLUMN = COLUMN + 1
				IF (ROW<=(LC_NUMBS(1)-NUMIC)) THEN 
					DO G = 1, NUMGSPT
						LOCBS(1) = JACOBI_POLY(GSPT(1,G), I)	! Row
						LOCBS(2) = JACOBI_POLY(GSPT(1,G), J)	! Column
						FDBS = GET_FD_JACOBI_POLY(GSPT(1,G), J)	!Column
						
						!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
						!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
						
						!! Example 2 in "On shifted Jacobi spectral approximation for solving fractional DE" (D^2u + sin(x)D^(1/2)u + xu = f(x))
						!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!
! 						LC_M(ROW, COLUMN) = LC_M(ROW, COLUMN) + (LOCBS(2)%VAL(2) + DSIN(GSPT(1,G) + PATCHBDPT(K,1))*FDBS + (GSPT(1,G) + PATCHBDPT(K,1))*LOCBS(2)%VAL(0))*LOCBS(1)%VAL(0)*GSW(1,G)
						!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!
						
						!! Example 1 in Master Thesis "Multistage Shifted Jacobi Spectral Method for solving linear & nonlinear Fractional Differential Equations"
						!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!
! 						LC_M(ROW, COLUMN) = LC_M(ROW, COLUMN) + FDBS*LOCBS(1)%VAL(0)*GSW(1,G)
						!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!
						
						!! Example 3. in "A high order schema for the numerical solution of the fractional ordinary differential equations"
						!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!
! 						LC_M(ROW, COLUMN) = LC_M(ROW, COLUMN) + (FDBS + LOCBS(2)%VAL(0))*LOCBS(1)%VAL(0)*GSW(1,G)
						!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!
						
						!! Example of highly oscillating function
						!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!
! 						LC_M(ROW, COLUMN) = LC_M(ROW, COLUMN) + (FDBS)*LOCBS(1)%VAL(0)*GSW(1,G)
						!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!
						
						!! Example 3. in "A new Jacobi operational matrix-An application for solving fractional differential equations"
						!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!
						LC_M(ROW, COLUMN) = LC_M(ROW, COLUMN) + (FDBS + LOCBS(2)%VAL(0))*LOCBS(1)%VAL(0)*GSW(1,G)
						!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!
					
						!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
						!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
					ENDDO
				ENDIF
			ENDDO
		ENDDO
		
		!! Update the load vector F_k
		!---------------------------------------------------------------------------------------------------------!
		!! Initialize
		LC_F(:) = 0.0D0
		!! Compute the inner product (f(t), p(t)) and subtract the fractional derivatives on the previos patches
		DO I = 1, LC_NUMBS(K) - NUMIC
			DO KK = 1, NUMGSPT
				LOCBS(1) = JACOBI_POLY(GSPT(1,KK), I-1)	! Row
				LC_F(I) = LC_F(I) + LDF1D(GSPT(1,KK) + PATCHBDPT(K,1))*LOCBS(1)%VAL(0)*GSW(1,KK)
			ENDDO
! 			PRINT*, I, GET_INNER_FD(SOL, I, K)
			LC_F(I) = LC_F(I) - GET_INNER_FD(SOL, I, K)		!(SUM(LC_NUMBS(1:K-2)) + 1:SUM(LC_NUMBS(1:K-1)))
		ENDDO
		!! Impose initial conditions
		DO J = 1, LC_NUMBS(K)
			LOCBS(1) = JACOBI_POLY(DELTAH, J-1)
			DO II = 1, NUMIC
				LC_UH(II,J)%VAL(II-1) = LOCBS(1)%VAL(II-1)
			ENDDO
		ENDDO
		DO II = 1, NUMIC
			LC_F(LC_NUMBS(K) - NUMIC + II) = DOT_PRODUCT(SOL(SUM(LC_NUMBS(1:K-2)) + 1:SUM(LC_NUMBS(1:K-1))), LC_UH(II,:)%VAL(II-1))
		ENDDO
		!---------------------------------------------------------------------------------------------------------!
		
! 		OPEN(1, FILE = './data/f2')
! 		DO II = 1, LC_NUMBS(1)
! 			WRITE(1,*) LC_F(II)
! 		ENDDO
! 		CLOSE(1)
		
		!! Copy M_k & F_k and then solve the linear system M_k[sol]=F_k
		!---------------------------------------------------------------------------------------------------------!
		DMY_M = LC_M
		
		CALL LUDCMP(LC_M, LC_NUMBS(K), LC_NUMBS(K), LC_INDX, D)
		CALL LUBKSB(LC_M, LC_NUMBS(K), LC_NUMBS(K), LC_INDX, LC_F)
		
		SOL(SUM(LC_NUMBS(1:K-1)) + 1:SUM(LC_NUMBS(1:K))) = LC_F(:)
		LC_M = DMY_M
! 		LC_F = INIT_F

! 		OPEN(1, FILE = './data/sol2')
! 		DO II = 1, LC_NUMBS(1)
! 			WRITE(1,*) LC_F(II)
! 		ENDDO
! 		CLOSE(1)
		
		!---------------------------------------------------------------------------------------------------------!
	ENDDO
	!---------------------------------------------------------------------------------------------------------!
	
	17 CONTINUE
	
	WRITE(*,*)
	WRITE(*,*) '<<< ASSEMBLE STIFFNESS MATRIX AND LOAD VECTOR : DONE >>>'
	WRITE(*,*)
	
	
END SUBROUTINE GEN_KF

REAL*8 FUNCTION GET_INNER_FD(SOL, ROW, PATCH)
	
	REAL*8, INTENT(IN) :: SOL(DOF)
	INTEGER, INTENT(IN) :: PATCH, ROW
	
	TYPE(FUNCTION_1D) :: P
	
	REAL*8 :: CQ, NUM, DEN
	REAL*8 :: S0, S1, S2, S3
	INTEGER :: I, J, K, II, JJ, KK, Q, G
	
	S3 = 0.0D0
	DO G = 1, NUMGSPT
		S2 = 0.0D0
		DO J = 1, PATCH-1
			S1 = 0.0D0
			DO KK = 0, JORDER
				S0 = 0.0D0
				DO Q = INT_M, KK
					NUM = (-1.0D0)**(KK - Q)*DEXP(GAMMLN(KK*1.0D0 + BETA + 1.0D0))*DEXP(GAMMLN(KK*1.0D0 + Q*1.0D0 + ALPHA + BETA + 1.0D0))
					DEN = DEXP(GAMMLN(Q*1.0D0 + BETA + 1.0D0))*DEXP(GAMMLN(KK*1.0D0 + ALPHA + BETA + 1.0D0))*DEXP(GAMMLN(KK*1.0D0 - Q*1.0D0 + 1.0D0))*DELTAH**Q*DEXP(GAMMLN(Q*1.0D0 - M + 1.0D0))
					CQ = NUM/DEN
					
					!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
					!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
					
					!! Example 2 in "On shifted Jacobi spectral approximation for solving fractional DE" (D^2u + sin(x)D^(1/2)u + xu = f(x))
					!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!
! 					S0 = S0 + CQ*DSIN(GSPT(1,G) + PATCHBDPT(PATCH,1))*(GSPT(1,G) + PATCHBDPT(PATCH,1) - PATCHBDPT(J,1))**(Q*1.0D0 - NU)*BETAI(Q*1.0D0 - M + 1.0D0, M - NU, DELTAH/(GSPT(1,G) + PATCHBDPT(PATCH,1) - PATCHBDPT(J,1)))
					!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!
					
					!! Example 1 in Master Thesis "Multistage Shifted Jacobi Spectral Method for solving linear & nonlinear Fractional Differential Equations"
					!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!
! 					S0 = S0 + CQ*(GSPT(1,G) + PATCHBDPT(PATCH,1) - PATCHBDPT(J,1))**(Q*1.0D0 - NU)*BETAI(Q*1.0D0 - M + 1.0D0, M - NU, DELTAH/(GSPT(1,G) + PATCHBDPT(PATCH,1) - PATCHBDPT(J,1)))
					!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!
					
					!! Example 3. in "A high order schema for the numerical solution of the fractional ordinary differential equations"
					!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!
! 					S0 = S0 + CQ*(GSPT(1,G) + PATCHBDPT(PATCH,1) - PATCHBDPT(J,1))**(Q*1.0D0 - NU)*BETAI(Q*1.0D0 - M + 1.0D0, M - NU, DELTAH/(GSPT(1,G) + PATCHBDPT(PATCH,1) - PATCHBDPT(J,1)))
					!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!
					
					!! Example of highly oscillating function
					!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!
! 					S0 = S0 + CQ*(GSPT(1,G) + PATCHBDPT(PATCH,1) - PATCHBDPT(J,1))**(Q*1.0D0 - NU)*BETAI(Q*1.0D0 - M + 1.0D0, M - NU, DELTAH/(GSPT(1,G) + PATCHBDPT(PATCH,1) - PATCHBDPT(J,1)))
					!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!
					
					!! Example 3. in "A new Jacobi operational matrix-An application for solving fractional differential equations"
					!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!
					S0 = S0 + CQ*(GSPT(1,G) + PATCHBDPT(PATCH,1) - PATCHBDPT(J,1))**(Q*1.0D0 - NU)*BETAI(Q*1.0D0 - M + 1.0D0, M - NU, DELTAH/(GSPT(1,G) + PATCHBDPT(PATCH,1) - PATCHBDPT(J,1)))
					!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!
					
					!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
					!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
! 					print*, g, q, BETAI(Q*1.0D0 - M + 1.0D0, M - NU, DELTAH/(GSPT(PATCH,G)-PATCHBDPT(J,1)))
! 					PRINT*, G, Q, INCOB(Q*1.0D0 - M + 1.0D0, M - NU, DELTAH/(GSPT(PATCH,G)-PATCHBDPT(J,1)))
				ENDDO
				S1 = S1 + SOL(SUM(LC_NUMBS(1:J-1))+1+KK)*S0
! 				print*, g, kk, SOL(SUM(LC_NUMBS(1:J-1))+1+KK)*S0
			ENDDO
! 			print*, 's1=', g, gspt(patch,g), s1
			S2 = S2 + S1
		ENDDO
! 		print*, 's2=', g, gspt(patch,g), s2
		P = JACOBI_POLY(GSPT(1,G), ROW-1)
		S3 = S3 + S2*P%VAL(0)*GSW(1,G)
! 		PRINT*, 'G=',G, S2*P%VAL(0)
	ENDDO
	S3 = (1.0D0/DEXP(GAMMLN(M - NU)))*S3
	GET_INNER_FD = S3
	
END FUNCTION GET_INNER_FD

END MODULE ASSEMBLE_GAL
